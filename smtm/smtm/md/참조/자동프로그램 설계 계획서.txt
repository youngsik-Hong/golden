============================================
📄 BBI V16 기반 실시간 자동매매 프로그램 — 사양서 (메모장 버전)
============================================

버전: 1.0
작성일: YYYY-MM-DD
작성자: GPT + 사용자 공동 설계

1. 시스템 개요

본 시스템은 PyQt 데스크탑 UI + smtm 기반 전략 엔진 + 실시간 Upbit 데이터 수집 구조로 이루어진 자동 매매 프로그램이다.
두 가지 매매 모드를 제공한다.

수동 모드 (Manual Trading Mode)
사용자가 특정 코인을 선택하면 실시간 데이터를 받아 전략 V16에 따라 자동으로 매매한다.

자동 스캐너 모드 (Auto Scanner Mode)
Upbit 전 코인을 스캔하여 거래량 상위 종목부터 전략 조건을 만족하면 자동 진입하고, 청산 후 다시 스캔한다.

본 시스템은 초기에 모의거래(Paper Trading) 를 목표로 하며, 실거래는 향후 선택적으로 연결한다.

2. 전체 아키텍처 구성

시스템은 크게 다음 세 영역으로 구성된다:

2.1 UI Layer (PyQt)

Tuning UI (이미 구현됨)

Manual Trading UI

Auto Scanner UI

실시간 상태 표시

로그 출력창

전략 파라미터 JSON 저장/불러오기 기능

2.2 Trading Core Layer

Strategy V16 (Volume 확장 버전)

Data Providers

UpbitDataProvider (실시간)

SimulationDataProvider (백테스트)

Trading Controllers

ManualTradingController

AutoScannerTradingController

OrderExecutor

PaperTradingExecutor (모의 주문)

RealTradingExecutor (향후 선택)

2.3 Data Layer

Upbit Open API

smtm.db (시뮬레이션 데이터)

로그파일(선택)

3. 모듈별 상세 사양

========================================

3.1 Strategy V16

========================================
이미 구현된 전략을 그대로 사용한다.
전략의 핵심 동작:

지표 계산 (BBI, RSI, MACD, Stoch, Volume Spike 등)

1~5차 매매 조건

비상 손절 (1~2차: -8~10%)

5차 이후 확정손절 (-2%)

랠리 트레일링 매도

쿨다운(매수/매도)

전략 입력:

candle 정보 1개 단위로 update_trading_info 호출

주문 요청은 OrderExecutor로 전달

전략 출력:

long/buy, close/sell 신호 발생 시 주문 객체 반환

========================================

3.2 Data Providers

========================================

3.2.1 UpbitDataProvider (실시간)

Input:

market (예: "BTC", "ETH", "DOGE")

interval (1분, 3분, 5분 등)

Output:

다음과 같은 candle dict:

{
    "type": "primary_candle",
    "market": "BTC",
    "date_time": "YYYY-MM-DD HH:MM:SS",
    "opening_price": ...,
    "high_price": ...,
    "low_price": ...,
    "closing_price": ...,
    "acc_volume": ...,
    "acc_price": ...
}


역할:

Upbit API에서 현재 캔들을 주기적으로 받아 전략에 전달

실패시 재시도/로그 출력 기능 포함

3.2.2 SimulationDataProvider

백테스트 시 smtm.db 파일에서 과거 데이터를 순차적으로 제공
UI에서 실행되는 백테스트는 이것을 사용

========================================

3.3 OrderExecutor

========================================

3.3.1 PaperTradingExecutor (초기 구현)

필수 기능:

매수/매도 요청을 메모리상의 포지션 상태로 기록

평균단가 계산

포지션 수량 계산

평가손익 계산

UI에 실시간 업데이트 이벤트 제공

3.3.2 RealTradingExecutor (향후 선택)

Upbit API로 실거래

현재 단계에서는 구현하지 않음

========================================

3.4 ManualTradingController

========================================

ManualTradingController는 다음 흐름을 따른다:

UI에서

심볼 선택 (예: BTC/KRW → BTC)

“코인 거래 시작” 클릭

Controller는 다음을 초기화

UpbitDataProvider(currency)

Strategy V16 인스턴스

PaperTradingExecutor

Trade Loop Thread 실행

Loop 실행 로직

while running:
    candle = provider.get_info()
    signal = strategy.update_trading_info(candle)
    if signal:
        executor.execute(signal)
    UI.update(position, pnl, logs)
    sleep(interval)


“정지” 클릭 → loop clean shutdown

Manual 모드는 항상 단일 코인 에만 집중한다.
포지션 종료 전에는 코인 변경 불가.

========================================

3.5 AutoScannerTradingController

========================================

자동 스캐너 모드는 다음 절차를 반복한다:

Upbit 시장 모든 KRW-* 심볼 목록 조회

최근 거래량 또는 거래대금 기준 상위 N개를 선정

각 코인에 대해 다음 조건을 검사:

빠른 체크용 필터(EMA distance, ATR percentile 등 매우 단순한 조건)

조건 만족하는 경우 해당 코인에 대해 ManualTradingController와 동일한 방식으로 전략 실행

포지션 보유 중에는 스캔 중지

포지션이 청산되면 다시 스캐닝 재개

스캔 주기: 5초~10초 추천
(Upbit API Rate Limit 대비 필요)

자동 모드에서는 동시에 여러 코인을 보유하지 않는다.
(전략 안정성 확보를 위해 처음엔 단일 포지션 구조로 시작)

4. UI 사양

UI는 다음 세 탭으로 구성된다:

4.1 Tuning 탭

이미 구현됨 (전략 파라미터 설정)

4.2 Manual Mode 탭

UI 구성:

코인 선택 콤보박스 (BTC, ETH, …)

“코인 거래 시작” 버튼

“정지” 버튼

현재 상태 패널:

현재 코인

포지션 수량

평균단가

평가손익

실시간 로그창

핵심 요구사항:

거래 중 UI 멈춤 없음 (스레드 사용)

시작/정지 시 예외 없이 자연스럽게 종료

4.3 Auto Scanner Mode 탭

UI 구성:

거래량 상위 N개 설정 SpinBox

스캐너 주기 설정

“자동 거래 시작” / “정지”

현재 스캔 중 코인 표시

진입한 코인 표시

포지션/손익 표시

전체 스캔 로그

5. 단계별 개발 계획
Phase 1 — 설계 (현재 문서)

전체 시스템 구조 확정

UI/Controller/Provider/Strategy/Executor 책임 정의

Upbit 사용 범위 정의

Phase 2 — 수동 모드 기반 엔진 구축

UpbitDataProvider 테스트

Strategy V16 연결

PaperTradingExecutor 구현

ManualTradingController 구현 (콘솔)

Phase 3 — 수동 모드 UI 완성

Manual Trading UI 탭 구현

Controller와 연결

포지션/손익 UI 업데이트

Phase 4 — 자동 스캐너 모드 구현

업비트 KRW-* 리스트 가져오기

거래량 상위 N개 정렬

AutoScannerTradingController 구현

UI 추가

Phase 5 — 통합 테스트 & 리스크 보완

예외 처리

강제 종료 방지

API 에러 핸들링

로그 정리

6. 파일 구성 제안

프로젝트 구조:

project/
 ├─ ui/
 │    ├─ main_window.py
 │    ├─ manual_tab.py
 │    ├─ auto_tab.py
 │    └─ tuning_tab.py (이미 있음)
 ├─ core/
 │    ├─ strategy_v16.py
 │    ├─ trading_controller_manual.py
 │    ├─ trading_controller_auto.py
 │    ├─ order_executor_paper.py
 │    └─ order_executor_real.py (선택)
 ├─ data/
 │    ├─ upbit_provider.py
 │    └─ simulation_provider.py
 ├─ logs/
 ├─ smtm/ (외부 라이브러리)
 └─ main.py

7. 향후 확장

멀티코인 동시매매

포트폴리오 리스크 관리

백테스트 결과 기반 종목 자동 추천

실거래 모드 연결

Discord/Telegram 알림

8. 결론

이 사양서는 V16 전략을 기반으로 한 완성형 자동매매 시스템의 전체 구조와 구현 계획을 담고 있다.
이 사양서를 기준으로 단계별 구현을 진행하면 개발 난이도를 최소화하고 안정적인 결과를 얻을 수 있다.

이후 단계에서는:

✅ Phase 2 — 수동 모드 엔진 뼈대 구축 (Upbit → Strategy → Executor)
부터 구현을 시작한다.
